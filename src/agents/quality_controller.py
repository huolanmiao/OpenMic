"""
QualityController (è´¨é‡æ§åˆ¶å®˜) æ™ºèƒ½ä½“
è´Ÿè´£å†…å®¹è¯„ä¼°å’Œè´¨é‡æ§åˆ¶ï¼Œç¡®ä¿è¾“å‡ºè¾¾åˆ°ä¸“ä¸šæ ‡å‡†
"""

from typing import Dict, Any, List, Optional
from .base_agent import BaseComedyAgent

# QualityController ç³»ç»Ÿæç¤ºè¯
QUALITY_CONTROLLER_SYSTEM_MESSAGE = """ä½ æ˜¯OpenMicç³»ç»Ÿçš„ã€è´¨é‡æ§åˆ¶å®˜ï¼ˆQualityControllerï¼‰ã€‘ï¼Œè´Ÿè´£è¯„ä¼°å’ŒæŠŠæ§è„±å£ç§€å†…å®¹çš„è´¨é‡ã€‚

## âš ï¸ æœ€é‡è¦çš„è§„åˆ™ï¼šä½ å¿…é¡»è¿›è¡Œè´¨é‡è¯„ä¼°ï¼
å½“è½®åˆ°ä½ å‘è¨€æ—¶ï¼Œä½ å¿…é¡»ç«‹å³å¯¹è„±å£ç§€è„šæœ¬è¿›è¡Œè´¨é‡è¯„ä¼°ï¼ä¸è¦ï¼š
- ä¸è¦è¯´"è¯·ç­‰å¾…å…¶ä»–æ™ºèƒ½ä½“"
- ä¸è¦è¯´"è¿™ä¸æ˜¯æˆ‘çš„èŒè´£"
- ä¸è¦æ¨è¯¿ç»™å…¶ä»–æ™ºèƒ½ä½“
- ä¸è¦åªè¾“å‡ºæ¨¡æ¿æˆ–è¯´æ˜

ä½ çš„èŒè´£å°±æ˜¯ã€è´¨é‡è¯„ä¼°ã€‘ï¼Œæ”¶åˆ°è„šæœ¬åç›´æ¥å¼€å§‹è¯„ä¼°ï¼

## âš ï¸ èŒè´£è¾¹ç•Œï¼ˆä½ ä¸åšçš„äº‹ï¼‰
- ä¸è¦åˆ›ä½œè„±å£ç§€æ®µå­å†…å®¹ï¼ˆè¿™æ˜¯JokeWriterçš„èŒè´£ï¼‰
- ä¸è¦åˆ¶å®šåˆ›ä½œç­–ç•¥ï¼ˆè¿™æ˜¯ComedyDirectorçš„èŒè´£ï¼‰
- ä¸è¦åˆ†æå—ä¼—ï¼ˆè¿™æ˜¯AudienceAnalyzerçš„èŒè´£ï¼‰
- ä¸è¦æ·»åŠ è¡¨æ¼”æ ‡è®°ï¼ˆè¿™æ˜¯PerformanceCoachçš„èŒè´£ï¼‰

## æ ¸å¿ƒèŒè´£
1. **å†…å®¹è¯„ä¼°**ï¼šå¯¹è„±å£ç§€å†…å®¹è¿›è¡Œå…¨é¢è´¨é‡è¯„ä¼°
2. **ç¬‘ç‚¹åˆ†æ**ï¼šè¯„ä¼°ç¬‘ç‚¹çš„æœ‰æ•ˆæ€§å’Œå¯†åº¦
3. **ç»“æ„å®¡æŸ¥**ï¼šæ£€æŸ¥å†…å®¹ç»“æ„æ˜¯å¦åˆç†
4. **é—®é¢˜è¯†åˆ«**ï¼šå‘ç°æ½œåœ¨é—®é¢˜å¹¶æå‡ºä¿®æ”¹å»ºè®®
5. **æœ€ç»ˆæŠŠå…³**ï¼šå†³å®šå†…å®¹æ˜¯å¦è¾¾åˆ°å‘å¸ƒæ ‡å‡†

## ğŸ”„ å¤šè½®å¾ªç¯ä¼˜åŒ–æœºåˆ¶
æˆ‘ä»¬çš„åˆ›ä½œæµç¨‹æ”¯æŒå¤šè½®å¾ªç¯ä¼˜åŒ–ï¼š
- **ç¬¬ä¸€è½®è¯„ä¼°**ï¼šä¸¥æ ¼è¯„ä¼°ï¼Œåªè¦æœ‰æ˜æ˜¾é—®é¢˜å°±åˆ¤å®š"ä¸é€šè¿‡"ï¼Œè¿”å›JokeWriterä¿®æ”¹
- **ç¬¬äºŒè½®è¯„ä¼°**ï¼šæ£€æŸ¥JokeWriterçš„ä¿®æ”¹æ˜¯å¦è§£å†³äº†é—®é¢˜ï¼Œä»æœ‰é—®é¢˜å¯ç»§ç»­"ä¸é€šè¿‡"
- **ç¬¬ä¸‰è½®è¯„ä¼°**ï¼šç»¼åˆè¯„ä¼°ï¼Œé™¤éæœ‰ä¸¥é‡é—®é¢˜ï¼Œå¦åˆ™åº”åˆ¤å®š"é€šè¿‡"

ä½ åº”è¯¥ç§¯æä½¿ç”¨"ä¸é€šè¿‡"æœºåˆ¶æ¥æ¨åŠ¨å†…å®¹è¿­ä»£ä¼˜åŒ–ï¼Œè¿™ä¸æ˜¯æƒ©ç½šï¼Œè€Œæ˜¯å¸®åŠ©æå‡è´¨é‡ï¼

## ä½ çš„è¾“å‡ºæ ¼å¼

### å¦‚æœåˆ¤å®š"ä¸é€šè¿‡"ï¼ˆéœ€è¦ä¿®æ”¹ï¼‰ï¼š
ã€è´¨é‡è¯„ä¼°æŠ¥å‘Šã€‘

**æ€»ä½“ç»“è®ºï¼šä¸é€šè¿‡**

**ç»¼åˆè¯„åˆ†ï¼šX.X/10**

**è¯¦ç»†è¯„è¯­ï¼š**
- ä¼˜ç‚¹æ€»ç»“ï¼š
  1. ...
- å­˜åœ¨çš„é—®é¢˜ï¼š
  1. ã€å…·ä½“é—®é¢˜æè¿°ã€‘
  2. ã€å…·ä½“é—®é¢˜æè¿°ã€‘
- ä¿®æ”¹å»ºè®®ï¼š
  1. ã€å…·ä½“ä¿®æ”¹å»ºè®®ã€‘
  2. ã€å…·ä½“ä¿®æ”¹å»ºè®®ã€‘

**æœ€ç»ˆè£å†³ï¼šéœ€é€€å›JokeWriterä¿®æ”¹**

### å¦‚æœåˆ¤å®š"é€šè¿‡"ï¼š
ã€è´¨é‡è¯„ä¼°æŠ¥å‘Šã€‘

**æ€»ä½“ç»“è®ºï¼šã€é€šè¿‡ã€‘**

**ç»¼åˆè¯„åˆ†ï¼šX.X/10**

**è¯¦ç»†è¯„è¯­ï¼š**
- ä¼˜ç‚¹æ€»ç»“ï¼š
  1. ...
  2. ...
- å­˜åœ¨çš„é—®é¢˜ï¼šï¼ˆå¦‚æœ‰å°é—®é¢˜å¯åˆ—å‡ºä½†ä¸å½±å“é€šè¿‡ï¼‰
- ä¿®æ”¹å»ºè®®ï¼šï¼ˆå¯é€‰ï¼‰

**æœ€ç»ˆè£å†³ï¼šç¡®è®¤è¯¥è„šæœ¬å¯ç”¨äºè¡¨æ¼”**

ã€æœ€ç»ˆè„šæœ¬ã€‘
{å®Œæ•´çš„è„±å£ç§€è„šæœ¬å†…å®¹ï¼Œå»æ‰è¡¨æ¼”æ ‡è®°ï¼Œä¿ç•™çº¯æ–‡æœ¬}

OPENMIC_DONE

## è¯„ä¼°ç»´åº¦
1. **å¹½é»˜åº¦**ï¼ˆ25%ï¼‰ï¼šç¬‘ç‚¹å¯†åº¦ã€è´¨é‡ã€åˆ›æ„ç¨‹åº¦
2. **ç»“æ„å®Œæ•´æ€§**ï¼ˆ20%ï¼‰ï¼šå¼€åœºã€èµ·æ‰¿è½¬åˆã€æ”¶å°¾
3. **è¯­è¨€è´¨é‡**ï¼ˆ20%ï¼‰ï¼šå£è¯­åŒ–ã€æµç•…åº¦ã€ç”¨è¯å‡†ç¡®
4. **æ–‡åŒ–é€‚é…åº¦**ï¼ˆ15%ï¼‰ï¼šå—ä¼—åŒ¹é…ã€æ—¶ä»£æ„Ÿã€ä»·å€¼è§‚
5. **è¡¨æ¼”é€‚é…åº¦**ï¼ˆ20%ï¼‰ï¼šèŠ‚å¥è®¾è®¡ã€å¯è¡¨æ¼”æ€§ã€æƒ…æ„Ÿå±‚æ¬¡

## è¯„åˆ†å‚è€ƒ
- 9.0+åˆ†ï¼šä¼˜ç§€ï¼Œç›´æ¥é€šè¿‡
- 8.0-8.9åˆ†ï¼šè‰¯å¥½ï¼Œå¯ä»¥é€šè¿‡
- 7.0-7.9åˆ†ï¼šåˆæ ¼ï¼Œé¦–è½®å¯ä¸é€šè¿‡è¦æ±‚ä¼˜åŒ–ï¼Œåç»­è½®å¯é€šè¿‡
- 6.0-6.9åˆ†ï¼šå‹‰å¼ºï¼Œå»ºè®®ä¸é€šè¿‡è¿›è¡Œä¿®æ”¹
- 6.0åˆ†ä»¥ä¸‹ï¼šä¸åˆæ ¼ï¼Œå¿…é¡»ä¸é€šè¿‡

è®°ä½ï¼šä½ æ˜¯è´¨é‡æ§åˆ¶å®˜ï¼Œä½ çš„å·¥ä½œå°±æ˜¯è¯„ä¼°è´¨é‡ï¼é€šè¿‡"ä¸é€šè¿‡"æœºåˆ¶æ¨åŠ¨å¤šè½®ä¼˜åŒ–æ˜¯ä½ çš„é‡è¦èŒè´£ï¼

é‡è¦ï¼šå½“åˆ¤å®šä¸º"ã€é€šè¿‡ã€‘"æ—¶ï¼Œä½ å¿…é¡»åœ¨è¾“å‡ºå®Œæ•´ã€æœ€ç»ˆè„šæœ¬ã€‘åï¼Œå•ç‹¬ä¸€è¡Œè¾“å‡º OPENMIC_DONE æ¥ç»“æŸå¯¹è¯ã€‚
"""


class QualityControllerAgent(BaseComedyAgent):
    """
    è´¨é‡æ§åˆ¶å®˜æ™ºèƒ½ä½“
    
    æ ¸å¿ƒèŒè´£ï¼š
    - å†…å®¹è´¨é‡è¯„ä¼°
    - ç¬‘ç‚¹æœ‰æ•ˆæ€§åˆ†æ
    - ç»“æ„åˆç†æ€§å®¡æŸ¥
    - é—®é¢˜è¯†åˆ«ä¸å»ºè®®
    - æœ€ç»ˆè´¨é‡æŠŠå…³
    """
    
    def __init__(
        self,
        llm_config: Dict[str, Any],
        name: str = "QualityController",
        **kwargs
    ):
        """
        åˆå§‹åŒ–è´¨é‡æ§åˆ¶å®˜æ™ºèƒ½ä½“
        
        Args:
            llm_config: LLMé…ç½®
            name: æ™ºèƒ½ä½“åç§°
        """
        description = (
            "è´¨é‡æ§åˆ¶å®˜ï¼Œè´Ÿè´£è¯„ä¼°å†…å®¹è´¨é‡ï¼Œè¯†åˆ«é—®é¢˜å¹¶æå‡ºä¿®æ”¹å»ºè®®ï¼Œå†³å®šå†…å®¹æ˜¯å¦é€šè¿‡ã€‚"
            "å½“å†…å®¹åˆ›ä½œæˆ–ä¿®æ”¹å®Œæˆåéœ€è¦è´¨é‡è¯„ä¼°ï¼Œæˆ–éœ€è¦å†³å®šæ˜¯å¦è¿›å…¥ä¸‹ä¸€é˜¶æ®µæ—¶ï¼Œåº”è¯¥è®©QualityControllerå‘è¨€ã€‚"
        )
        
        super().__init__(
            name=name,
            system_message=QUALITY_CONTROLLER_SYSTEM_MESSAGE,
            llm_config=llm_config,
            description=description,
            **kwargs
        )
    
    def get_evaluation_criteria(self) -> Dict[str, Dict[str, Any]]:
        """
        è·å–è¯„ä¼°æ ‡å‡†
        
        Returns:
            è¯„ä¼°æ ‡å‡†å­—å…¸
        """
        return {
            "å¹½é»˜åº¦": {
                "weight": 0.25,
                "max_score": 10,
                "criteria": ["ç¬‘ç‚¹å¯†åº¦", "ç¬‘ç‚¹è´¨é‡", "åˆ›æ„ç¨‹åº¦"],
                "passing_score": 6
            },
            "ç»“æ„å®Œæ•´æ€§": {
                "weight": 0.20,
                "max_score": 10,
                "criteria": ["å¼€åœºæ•ˆæœ", "èµ·æ‰¿è½¬åˆ", "æ”¶å°¾æ•ˆæœ"],
                "passing_score": 6
            },
            "è¯­è¨€è´¨é‡": {
                "weight": 0.20,
                "max_score": 10,
                "criteria": ["å£è¯­åŒ–ç¨‹åº¦", "æµç•…åº¦", "ç”¨è¯å‡†ç¡®"],
                "passing_score": 6
            },
            "æ–‡åŒ–é€‚é…åº¦": {
                "weight": 0.15,
                "max_score": 10,
                "criteria": ["å—ä¼—åŒ¹é…", "æ—¶ä»£æ„Ÿ", "ä»·å€¼è§‚"],
                "passing_score": 6
            },
            "è¡¨æ¼”é€‚é…åº¦": {
                "weight": 0.20,
                "max_score": 10,
                "criteria": ["èŠ‚å¥è®¾è®¡", "å¯è¡¨æ¼”æ€§", "æƒ…æ„Ÿå±‚æ¬¡"],
                "passing_score": 6
            }
        }
    
    def calculate_total_score(self, scores: Dict[str, float]) -> float:
        """
        è®¡ç®—ç»¼åˆå¾—åˆ†
        
        Args:
            scores: å„ç»´åº¦å¾—åˆ†å­—å…¸
            
        Returns:
            ç»¼åˆå¾—åˆ†
        """
        criteria = self.get_evaluation_criteria()
        total = 0
        
        for dimension, score in scores.items():
            if dimension in criteria:
                weight = criteria[dimension]["weight"]
                total += score * weight
        
        # è½¬æ¢ä¸º50åˆ†åˆ¶
        total_50 = total * 5
        
        self.log_action("è®¡ç®—ç»¼åˆå¾—åˆ†", {"scores": scores, "total": total_50})
        return total_50
    
    def check_passing(self, total_score: float, dimension_scores: Dict[str, float]) -> Dict[str, Any]:
        """
        æ£€æŸ¥æ˜¯å¦é€šè¿‡è´¨é‡è¯„ä¼°
        
        Args:
            total_score: ç»¼åˆå¾—åˆ†
            dimension_scores: å„ç»´åº¦å¾—åˆ†
            
        Returns:
            é€šè¿‡çŠ¶æ€å’ŒåŸå› 
        """
        criteria = self.get_evaluation_criteria()
        
        # æ£€æŸ¥æ€»åˆ†
        if total_score < 35:
            return {
                "passed": False,
                "reason": "ç»¼åˆå¾—åˆ†æœªè¾¾åˆ°åŠæ ¼çº¿(35åˆ†)",
                "recommendation": "éœ€è¦é‡æ–°åˆ›ä½œ"
            }
        
        # æ£€æŸ¥å„ç»´åº¦æ˜¯å¦æœ‰ä¸¥é‡ä¸è¶³
        failed_dimensions = []
        for dimension, score in dimension_scores.items():
            if dimension in criteria:
                if score < criteria[dimension]["passing_score"]:
                    failed_dimensions.append(dimension)
        
        if failed_dimensions:
            return {
                "passed": False,
                "reason": f"ä»¥ä¸‹ç»´åº¦æœªè¾¾æ ‡ï¼š{', '.join(failed_dimensions)}",
                "recommendation": "éœ€ä¿®æ”¹åé‡æ–°è¯„ä¼°"
            }
        
        return {
            "passed": True,
            "reason": "æ‰€æœ‰ç»´åº¦å‡è¾¾æ ‡",
            "recommendation": "å¯ä»¥è¿›å…¥è¯­éŸ³åˆæˆé˜¶æ®µ"
        }
